# GEMINI 기술 인수인계 문서 (v10 - 최종)

**문서 목적**: 이 문서는 다른 Gemini AI 에이전트가 프로젝트의 기술적 맥락, 설계 결정, 개발 과정을 완벽하게 이해하고 작업을 원활하게 이어받을 수 있도록 작성되었습니다.

---
## 1. 프로젝트 개요 (최종: 국내 주식 전용)
*(기존 내용과 동일)*

---

## 2. 핵심 아키텍처 및 설계 결정 (최종)
*(기존 내용과 동일)*

---

## 3. 기능별 핵심 파일 경로 (최종)
*(기존 내용과 동일)*

---

## 4. 개발 이력 및 문제 해결 (Troubleshooting History) - **최종 회고**

*(기존 문제 해결 이력은 생략)*

- **(신규) 매매 복기 기능 전체 구현 및 디버깅**:
  - **목표**: 사용자가 자신의 투자 내역을 기록하고, 수익률을 추적하며 투자 결정을 복기할 수 있는 '매매 복기' 기능을 구현.
  - **구현 내용**:
    1.  **데이터 구조 및 Context**: `TradeLogContext`를 생성하여 `localStorage` 기반의 매매 기록 CRUD 기능을 구현.
    2.  **매매 복기 페이지 UI**: `mistakes/page.tsx`에 매매 기록 테이블과 "직접 입력" 및 "수정" 버튼을 구현.
    3.  **통합 입/수정 모달**: `add-trade-log-modal.tsx`에서 신규 기록 추가와 기존 기록 수정을 모두 처리하도록 로직을 통합.
    4.  **UX/UI 개선**:
        - **환율 연동**: `CurrencyContext`와 연동하여 테이블과 모달의 모든 금액을 현재 통화(KRW/USD) 설정에 맞게 자동 변환하여 표시. 저장 시에는 KRW로 일관되게 저장.
        - **UI 개선**: 테이블 헤더에 통화 단위를 아이콘으로 표시하고, 모달의 금액 입력창 내부에 통화 아이콘을 추가하여 가독성 향상.
        - **데이터 시각화**: 매도 정보가 없는 항목에 'N/A' 대신 아이콘(`MinusCircle`)을 표시하여 시각적 명확성 개선.
  - **주요 디버깅**:
    - **`NaN` 오류**: API 응답의 숫자 값에 포함된 쉼표(,) 문제. API 라우트에서 쉼표를 제거하여 해결.
    - **데이터 불일치 오류**: API 응답 키(`PascalCase`)와 클라이언트 기대 키(`camelCase`) 불일치 문제. `stock-search.tsx`에서 데이터 키를 변환하여 해결.
    - **Zod 스키마 유효성 검사 오류**:
        - 매도 관련 필드를 모두 비웠을 때 유효성 검사에 실패하는 문제. `z.preprocess`를 사용하여 빈 문자열을 `undefined`로 변환 후 검증하여 해결.
        - "매도량"이 "매수량"보다 많을 수 없도록 `superRefine`을 사용하여 복합 필드 유효성 검사 로직을 추가.
        - **(신규)** "매도일"이 "매수일"보다 이전일 수 없도록 `superRefine` 검증 로직과 캘린더 UI의 `disabled` 속성을 연동하여 처리.
    - **`useEffect` 의존성 배열 오류**: `react-hook-form`의 `form` 객체 전체를 의존성 배열에 포함시켜 발생. 안정적인 `reset` 함수만 추출하여 전달하는 방식으로 해결.

- **(신규) 캘린더 UI 구현 및 스타일링 문제 해결**:
  - **목표**: 날짜 입력 필드를 텍스트에서 캘린더 팝업으로 변경하여 사용자 경험을 개선.
  - **구현 내용**:
    1.  **라이브러리 설치**: `react-day-picker`와 `date-fns`를 프로젝트에 추가.
    2.  **컴포넌트 생성**: `shadcn/ui` 스타일의 `Calendar` 컴포넌트(`calendar.tsx`)를 생성하고, 이를 `Popover`와 조합하여 `add-trade-log-modal.tsx`의 날짜 입력 필드에 적용.
  - **주요 디버깅 (스타일링 충돌)**:
    - **현상**: `react-day-picker` v8 이상으로 업데이트되면서 내부 클래스명과 API 구조가 변경되어, `shadcn/ui`의 기본 캘린더 스타일이 더 이상 호환되지 않아 UI가 깨지는 문제 발생.
    - **최종 해결책**: `react-day-picker` v8+의 변경된 클래스명에 맞춰 `calendar.tsx` 내부의 `classNames` prop을 수동으로 재정의하여 최신 버전에 호환되도록 스타일을 수정. (사용자가 직접 해결)

- **(신규) 매매 복기 모달 기능 개선 및 유효성 검사 강화**:
  - **목표**: `add-trade-log-modal.tsx`의 UX를 개선하고, 데이터 무결성을 위한 유효성 검사를 강화.
  - **구현 내용**:
    1. **현재가 조회 로직 수정**: "종목 상세 분석 → 거래하러 가기" 경로로 진입 시, `initialStock`의 `price`를 `buyPrice` 필드에 올바르게 설정하도록 `useEffect` 로직을 수정.
    2. **매도 정보 입력 규칙 개선**: 매도 관련 필드(매도가, 매도량, 매도일)가 일부만 입력되었을 때, Zod 스키마가 아닌 `infoMessage`와 `disabled` 속성을 연동하여 "안내창" UI를 유지하면서 저장 버튼을 비활성화하는 방식으로 UX 개선.
    3. **가격 유효성 검사 추가**: `buyPrice`는 항상 0보다 커야 하고, `sellPrice`는 모든 매도 정보가 입력되었을 때 0보다 커야 한다는 Zod 유효성 검사 규칙을 추가.
    4. **캘린더 위치 동적 조정**: `sellDate` 필드의 캘린더가 화면 아래 공간이 부족할 경우 위로 올라가는 문제를 해결하기 위해, `PopoverContent`의 `side` 속성을 `"top"`으로 동적 설정.

- **(신규) 매매 기록 분석 기능 구현 (객관적 지표 평가 기반)**:
  - **목표**: 사용자의 매매 기록을 바탕으로 객관적인 기준에 따라 성과를 분석하고, 투자 결정 과정을 복기할 수 있는 심층 분석 기능을 제공.
  - **1차 구현 (주관적 선호도 기반)**:
    - `analysis-utils.ts`, `analysis-client.tsx` 등 분석 기능 관련 파일을 생성하고 기본 UI(요약 카드, 상세 테이블)를 구현.
    - `trade-detail-modal.tsx`를 생성하여, 사용자의 투자 성향(`InvestmentPersonalityContext`)에 따른 **주관적 선호 기준**과 **현재 시점의 재무 지표**를 비교하는 초기 버전을 구현.
  - **2차 구현 (객관적 과거 데이터 기반으로 전면 개편)**:
    - **문제점**: "매수 당시"가 아닌 "현재" 지표를 사용하는 한계와 "주관적 선호" 기준의 확증 편향 가능성을 인지.
    - **개선 방향**: 사용자의 제안에 따라, **실제 매수/매도 당시의 과거 지표**를 **객관적인 시장 기준(가치주/성장주)**과 비교하는 방식으로 전면 개편.
  - **최종 구현 내용**:
    1. **과거 데이터 조회 API 생성**: `api/stock/historical/[symbol]/[date]/route.ts` API를 신규 생성. `kis-api.ts`의 `getStockPriceHistory` 함수를 수정하여 KIS API로부터 특정 과거일의 종가, 거래량 및 재무 지표(`output1`의 현재값)를 조회하도록 구현.
    2. **BPS 역산 로직 추가**: KIS API가 과거 BPS를 제공하지 않는 문제를 해결하기 위해, API 라우트에서 `BPS = 주가 / PBR` 공식을 이용해 BPS 값을 역산하여 클라이언트에 제공.
    3. **데이터 호출 방식 변경**: `analysis-client.tsx`에서 페이지 로딩 시 모든 데이터를 가져오는 대신, 사용자가 거래 내역을 **클릭하는 시점**에 매수일과 매도일의 과거 데이터를 각각 비동기적으로 호출하도록 변경.
    4. **상세 분석 모달 개편**: `trade-detail-modal.tsx`에서 `InvestmentPersonalityContext` 의존성을 제거.
        - **PER/PBR 재계산**: API로 받은 `EPS`, `BPS`와 **과거 종가**를 조합하여, 모달 내에서 **실제 매수/매도 시점의 PER, PBR을 직접 계산**.
        - **UI 개편**: "선호 지표 비교" → "**지표 평가**"로 변경. "가치주/성장주" 객관적 기준과 비교하는 테이블 UI로 전면 교체.
        - **분석 요약 고도화**: 단타 거래와 일반 거래를 구분. 일반 거래 시, 보유 기간 동안의 **PBR과 거래량 변화를 분석**하여 "시장의 가치 평가"와 "관심도" 변화에 대한 코멘트를 자동 생성.
        - **면책 조항 추가**: 모든 분석 정보의 한계를 명시하고, 최종 투자 책임은 사용자에게 있음을 알리는 문구 추가.
    5. **사이드바 아이콘 수정**: "매매 분석" 메뉴의 아이콘을 `BarChart3` → `CandlestickChart` → 최종적으로 `TrendingUp`으로 변경하여 다른 메뉴와의 시각적 변별력을 확보.
  - **주요 디버깅**:
    - **API `params` 오류**: Next.js App Router에서 API 라우트의 `params`가 Promise 형태로 전달되는 문제를 `await`로 해결.
    - **KIS API 응답 구조 변경 대응**: `FID_ETC_CLS_CODE` 파라미터 추가 시, 재무 지표가 `output2`가 아닌 `output1`에 담겨 반환되는 구조 변경에 맞춰 데이터 파싱 로직을 수정.
    - **BPS 누락 문제**: API 응답에 `BPS`가 없음을 인지하고, `PBR`과 주가를 이용해 역산하는 로직을 추가하여 PBR 계산 문제를 해결.
    - 다수의 빌드 오류 및 타입 오류 (컴포넌트 중복 선언, `catch` 블록 구문 오류, 훅 이름 오타 등) 해결.

---

## 5. 향후 개발 계획 (Future Development Plan)

**목표**: 매매 복기 기능의 사용성을 고도화하고 사용자 경험을 개선한다.

### 가. 매매 기록 수정 기능 고도화
- **현황**: 현재 매매 기록 수정 기능이 구현되었으나, UX 개선의 여지가 있음.
- **개발 계획**:
  1.  **수정 모드 명시**: 수정 모달이 열렸을 때, 사용자가 이를 명확히 인지할 수 있도록 UI를 개선 (예: 제목 강조, 버튼 텍스트 변경).
  2.  **변경 불가능 필드 처리**: 수정 시에는 '종목' 관련 정보(종목명, 종목코드)는 변경할 수 없도록 명확하게 비활성화 처리. (현재는 구현됨, UI 개선 필요)

---

## 6. 필수 환경 변수 (`.env.local` - 최종)
*(기존 내용과 동일)*
```
# GitHub OAuth App credentials
AUTH_GITHUB_ID=...
AUTH_GITHUB_SECRET=...

# Secret for signing NextAuth.js tokens
AUTH_SECRET...

# Korea Investment & Securities (KIS) API Key
KIS_APP_KEY=...
KIS_APP_SECRET=...
```
